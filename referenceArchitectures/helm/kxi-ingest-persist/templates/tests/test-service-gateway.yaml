apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "kxi-ingest-persist.fullname" . }}-test-service-gateway"
  labels:
    {{- include "kxi-ingest-persist.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  serviceAccountName: {{ include "kxi-ingest-persist.fullname" . }}-test
  restartPolicy: Never
  containers:
  - name: test-service-gateway
    image: curlimages/curl:latest
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "Testing Service Gateway HTTP endpoint..."
      SERVICE_NAME="{{ .Release.Name }}-kxi-gw-sg"
      HTTP_PORT=8080
      
      # Wait for service to be ready
      echo "Waiting for service ${SERVICE_NAME} to be ready..."
      echo "Endpoint: http://${SERVICE_NAME}:${HTTP_PORT}/meta"
      for i in $(seq 1 30); do
        if curl -f -s --max-time 5 http://${SERVICE_NAME}:${HTTP_PORT}/meta > /dev/null 2>&1; then
          echo "Service Gateway HTTP endpoint is accessible"
          break
        fi
        if [ $i -eq 30 ]; then
          echo "ERROR: Service Gateway HTTP endpoint not accessible after 30 attempts"
          exit 1
        fi
        echo "Attempt $i/30: Service not ready, waiting..."
        sleep 2
      done
      
      # Test HTTP endpoint
      echo "Testing HTTP endpoint connectivity..."
      # TODO
      
      echo "Service Gateway test completed successfully"

