apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "kxi-api.fullname" . }}-test-pods-ready"
  labels:
    {{- include "kxi-api.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  serviceAccountName: {{ include "kxi-api.fullname" . }}-test
  restartPolicy: Never
  containers:
  - name: test-pods-ready
    image: bitnami/kubectl:latest
    command:
    - /bin/bash
    - -c
    - |
      set -e
      echo "Checking if all kxi-api pods are ready..."
      
      RELEASE_NAME="{{ .Release.Name }}"
      NAMESPACE="{{ .Release.Namespace }}"
      
      # Check kxi-gw pods
      echo "Checking kxi-gw pods..."
      SG_PODS=$(kubectl get pods -n ${NAMESPACE} -l app=${RELEASE_NAME}-kxi-gw-sg --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l || echo "0")
      if [ "$SG_PODS" -lt "1" ]; then
        echo "ERROR: Service Gateway pods are not running"
        kubectl get pods -n ${NAMESPACE} -l app=${RELEASE_NAME}-kxi-gw-sg
        exit 1
      fi
      echo "SUCCESS: Service Gateway pods are running"
      
      # Check kxi-sp pods
      echo "Checking kxi-sp pods..."
      SP_PODS=$(kubectl get pods -n ${NAMESPACE} -l app.kubernetes.io/name=kxi-sp,app.kubernetes.io/instance=${RELEASE_NAME} --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l || echo "0")
      SP_REPLICAS={{ index .Values "kxi-sp" "replicaCount" | default "1" }}
      if [ "$SP_PODS" -lt "$SP_REPLICAS" ]; then
        echo "ERROR: Expected ${SP_REPLICAS} SP pods, found ${SP_PODS}"
        kubectl get pods -n ${NAMESPACE} -l app.kubernetes.io/name=kxi-sp,app.kubernetes.io/instance=${RELEASE_NAME}
        exit 1
      fi
      echo "SUCCESS: Stream Processor pods are running (${SP_PODS}/${SP_REPLICAS})"
      
      echo "All kxi-api pods are ready!"

